<br><br><br>
<div class="create-task-container">
  <!-- Compact Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="d-flex align-items-center gap-3">
        <button class="back-button" (click)="cancel()">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div class="header-title">
          <h1 class="display-6 fw-semibold mb-1">Create New Task</h1>
          <p class="text-muted mb-0">Define objectives, assign teams, and set deadlines</p>
        </div>
      </div>
      
      <div class="header-actions">
        <div class="form-progress">
          <div class="progress">
            <div class="progress-bar" role="progressbar" [style.width.%]="getFormProgress()"></div>
          </div>
          <small class="text-muted">{{ getFormProgress() }}% Complete</small>
        </div>
        
        <!-- <button class="btn btn-outline-primary btn-sm" (click)="toggleHelpText()">
          <i class="bi bi-lightbulb"></i> {{ showHelpText ? 'Hide Tips' : 'Tips' }}
        </button> -->
      </div>
    </div>
  </header>

  <!-- Floating Progress Steps -->
  <!-- <div class="floating-progress">
    <div class="steps-indicator">
      <div class="step" [class.active]="activeStep >= 1" (click)="scrollToSection('basic-info')">
        <span class="step-number">1</span>
        <span class="step-label">Basic Info</span>
      </div>
      <div class="step" [class.active]="activeStep >= 2" (click)="scrollToSection('departments')">
        <span class="step-number">2</span>
        <span class="step-label">Departments</span>
      </div>
      <div class="step" [class.active]="activeStep >= 3" (click)="scrollToSection('assignment')">
        <span class="step-number">3</span>
        <span class="step-label">Assignment</span>
      </div>
      <div class="step" [class.active]="activeStep >= 4" (click)="scrollToSection('schedule')">
        <span class="step-number">4</span>
        <span class="step-label">Schedule</span>
      </div>
    </div>
  </div> -->

  <main class="main-content">
    <!-- Success Animation -->
    <div class="success-animation">
      <div class="checkmark">âœ“</div>
      <div class="success-text">Task Created Successfully!</div>
    </div>

    <!-- Help Panel -->
    <!-- <div class="help-panel" *ngIf="showHelpText">
      <div class="help-header">
        <i class="bi bi-lightbulb"></i>
        <span>Quick Tips</span>
        <button class="btn-close" (click)="showHelpText = false"></button>
      </div>
      <div class="help-body">
        <div class="tip-item">
          <i class="bi bi-check-circle"></i>
          <span>Use clear, action-oriented titles for better tracking</span>
        </div>
        <div class="tip-item">
          <i class="bi bi-check-circle"></i>
          <span>Assign relevant departments to ensure proper visibility</span>
        </div>
        <div class="tip-item">
          <i class="bi bi-check-circle"></i>
          <span>Set realistic deadlines to maintain workflow efficiency</span>
        </div>
      </div>
    </div> -->

    <!-- Success/Error Messages -->
    <div *ngIf="successMessage" class="alert alert-success">
      <div class="d-flex align-items-center">
        <i class="bi bi-check-circle-fill"></i>
        <div class="ms-3">
          <h6>Success!</h6>
          <p class="mb-0">{{ successMessage }}</p>
        </div>
        <button type="button" class="btn-close" (click)="successMessage = null"></button>
      </div>
    </div>

    <div *ngIf="errorMessage" class="alert alert-danger">
      <div class="d-flex align-items-center">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <div class="ms-3">
          <h6>Attention Required</h6>
          <p class="mb-0">{{ errorMessage }}</p>
        </div>
        <button type="button" class="btn-close" (click)="errorMessage = null"></button>
      </div>
    </div>

    <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="task-form">
      <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-8">
          <!-- Basic Information -->
          <section class="form-section" id="basic-info">
            <div class="section-header">
              <div class="section-icon">
                <i class="bi bi-card-text"></i>
              </div>
              <div>
                <h3>Task Information</h3>
                <p>Define the core details of your task</p>
              </div>
            </div>

            <div class="section-body">
              <!-- Title -->
              <div class="form-group">
                <label for="taskTitle" class="form-label">
                  <i class="bi bi-tag"></i>
                  Task Title <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-pencil"></i>
                  </span>
                  <input type="text" class="form-control" id="taskTitle" formControlName="title"
                    placeholder="Enter task title" [class.is-invalid]="f.title.touched && f.title.errors">
                </div>
                <div class="form-hint">
                  <span>Keep it short and descriptive</span>
                  <span class="char-count">{{ f.title.value?.length || 0 }}/255</span>
                </div>
                <div *ngIf="f.title.touched && f.title.errors" class="invalid-feedback">
                  <i class="bi bi-exclamation-circle"></i>
                  <span *ngIf="f.title.errors?.required">Title is required</span>
                  <span *ngIf="f.title.errors?.maxlength">Maximum 255 characters</span>
                </div>
              </div>

              <!-- Description -->
              <div class="form-group">
                <label for="taskDescription" class="form-label">
                  <i class="bi bi-chat-left-text"></i>
                  Description
                </label>
                <textarea class="form-control" id="taskDescription" rows="4" formControlName="description"
                  placeholder="Provide detailed instructions, context, and expected outcomes..."></textarea>
                <div class="form-hint">
                  <span>Add clear instructions for better understanding</span>
                  <span class="char-count" [class.text-danger]="characterCount > 1900">
                    {{ characterCount }}/2000
                  </span>
                </div>
              </div>

              <!-- Status -->
              <div class="form-group">
                <label class="form-label">
                  <i class="bi bi-flag"></i>
                  Task Status <span class="text-danger">*</span>
                </label>
                <div class="status-grid">
                  <div class="status-card" [class.active]="f.status.value === 'UPCOMING'"
                    (click)="taskForm.patchValue({ status: 'UPCOMING' })">
                    <div class="status-icon">
                      <i class="bi bi-calendar-plus"></i>
                    </div>
                    <div class="status-content">
                      <h6>Upcoming</h6>
                      <p>Planned for future execution</p>
                    </div>
                    <div class="status-check">
                      <i class="bi bi-check"></i>
                    </div>
                  </div>
                  <div class="status-card" [class.active]="f.status.value === 'PENDING'"
                    (click)="taskForm.patchValue({ status: 'PENDING' })">
                    <div class="status-icon">
                      <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="status-content">
                      <h6>Pending</h6>
                      <p>Active and ready for work</p>
                    </div>
                    <div class="status-check">
                      <i class="bi bi-check"></i>
                    </div>
                  </div>
                </div>
                <div *ngIf="f.status.touched && f.status.errors" class="invalid-feedback">
                  <i class="bi bi-exclamation-circle"></i>
                  <span>Please select a task status</span>
                </div>
              </div>
            </div>
          </section>

          <!-- Departments -->
          <section class="form-section" id="departments">
            <div class="section-header">
              <div class="d-flex align-items-center justify-content-between w-100">
                <div class="d-flex align-items-center">
                  <div class="section-icon">
                    <i class="bi bi-building"></i>
                  </div>
                  <div>
                    <h3>Departments</h3>
                    <p>Select departments responsible for this task</p>
                  </div>
                </div>
                <span class="badge">{{ taskForm.value.departmentIds?.length || 0 }}</span>
              </div>
            </div>

            <div class="section-body">
              <!-- Quick Assign -->
              <div class="quick-assign mb-4">
                <label class="form-label mb-3">
                  <i class="bi bi-lightning"></i>
                  Quick Assign
                </label>
                <div class="quick-buttons">
                  <button type="button" class="btn btn-sm btn-outline-primary" (click)="quickAssign([1], [2])"
                    *ngIf="hasDepartment(1)">
                    <i class="bi bi-gear"></i> Administration
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-success" (click)="quickAssign([2], [3])"
                    *ngIf="hasDepartment(2)">
                    <i class="bi bi-cash-coin"></i> Finance
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-info" (click)="quickAssign([3], [4])"
                    *ngIf="hasDepartment(3)">
                    <i class="bi bi-megaphone"></i> Marketing
                  </button>
                </div>
              </div>

              <!-- Department Search -->
              <div class="search-box mb-4">
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-search"></i>
                  </span>
                  <input type="text" class="form-control" placeholder="Search departments..."
                    [(ngModel)]="deptSearch" (ngModelChange)="onDeptSearch()" [ngModelOptions]="{standalone: true}">
                  <button *ngIf="deptSearch" class="btn btn-outline-secondary" type="button"
                    (click)="clearDeptSearch()">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
              </div>

              <!-- Select All -->
              <div class="select-all-toggle mb-4">
                <div class="form-check form-switch">
                  <input type="checkbox" class="form-check-input" id="selectAllDepts" [checked]="selectAllDepts"
                    (change)="toggleSelectAllDepts()" [disabled]="taskForm.value.assignToSelf">
                  <label class="form-check-label" for="selectAllDepts">
                    <i class="bi bi-check2-all"></i>
                    Select All Departments
                  </label>
                </div>
              </div>

              <!-- Department List -->
              <div class="department-list">
                <div *ngIf="isLoadingDepartments" class="loading-skeleton">
                  <div class="skeleton-item" *ngFor="let _ of [1, 2, 3, 4]"></div>
                </div>

                <div *ngIf="!isLoadingDepartments && filteredDepartments.length === 0" class="empty-state">
                  <i class="bi bi-building-slash"></i>
                  <h5>No departments found</h5>
                  <p>Try adjusting your search criteria</p>
                </div>

                <div class="department-grid">
                  <div class="department-card" *ngFor="let dept of filteredDepartments"
                    [class.selected]="taskForm.value.departmentIds.includes(dept.departmentId)"
                    [class.disabled]="taskForm.value.assignToSelf && !currentUser?.departmentIds?.includes(dept.departmentId)">
                    <div class="department-card-body">
                      <input type="checkbox" class="form-check-input" [id]="'dept-' + dept.departmentId"
                        [checked]="taskForm.value.departmentIds.includes(dept.departmentId)"
                        (change)="updateDepartmentSelection(dept.departmentId, $event.target.checked)"
                        [disabled]="taskForm.value.assignToSelf && !currentUser?.departmentIds?.includes(dept.departmentId)">
                      <label [for]="'dept-' + dept.departmentId" class="department-label">
                        <div class="department-content">
                          <div class="department-icon">
                            <i class="bi bi-building"></i>
                          </div>
                          <div class="department-info">
                            <h6>{{ dept.name }}</h6>
                            <p>{{ (usersByDepartment.get(dept.departmentId) || []).length }} members</p>
                          </div>
                          <div class="department-badge">
                            <span class="badge">{{ getHodCount(dept.departmentId) }} HOD</span>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
          <!-- Assignment -->
          <section class="form-section" id="assignment" *ngIf="taskForm.value.departmentIds?.length">
            <div class="section-header">
              <div class="d-flex align-items-center justify-content-between w-100">
                <div class="d-flex align-items-center">
                  <div class="section-icon">
                    <i class="bi bi-people"></i>
                  </div>
                  <div>
                    <h3>Assignment</h3>
                    <p>Assign users to the task</p>
                  </div>
                </div>
                <span class="badge">{{ taskForm.value.assignedToIds?.length || 0 }}</span>
              </div>
            </div>

            <div class="section-body">
              <!-- Self Assignment -->
              <div *ngIf="taskForm.value.assignToSelf && currentUser" class="self-assign-card mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="avatar me-3">
                        <i class="bi bi-person"></i>
                      </div>
                      <div>
                        <h6>Assigned to You</h6>
                        <p class="mb-0">{{ currentUser.fullName }}</p>
                        <small class="badge">{{ currentUser.role }}</small>
                      </div>
                      <i class="bi bi-check-circle-fill text-success ms-auto"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- User Accordions -->
              <div class="user-accordion">
                <div class="accordion">
                  <div *ngFor="let deptId of taskForm.value.departmentIds; let i = index" class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button" type="button" [class.collapsed]="i !== 0"
                        data-bs-toggle="collapse" [attr.data-bs-target]="'#collapse-' + deptId">
                        <div class="d-flex align-items-center w-100">
                          <div class="avatar me-3">
                            <i class="bi bi-building"></i>
                          </div>
                          <div>
                            <h6 class="mb-0">{{ getDepartmentName(deptId) }}</h6>
                            <small>{{ (filteredUsersByDept.get(deptId) || []).length }} users</small>
                          </div>
                          <span class="badge ms-auto">{{ selectedUsersByDeptObj[deptId]?.length || 0 }}</span>
                        </div>
                      </button>
                    </h2>
                    <div [id]="'collapse-' + deptId" class="accordion-collapse collapse" [class.show]="i === 0">
                      <div class="accordion-body">
                        <!-- User Search -->
                        <div class="search-box mb-3">
                          <div class="input-group input-group-sm">
                            <span class="input-group-text">
                              <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" placeholder="Search users..."
                              [(ngModel)]="userSearchByDept[deptId]" (ngModelChange)="onUserSearch(deptId)"
                              [ngModelOptions]="{standalone: true}">
                          </div>
                        </div>

                        <!-- Select All Users -->
                        <div class="form-check mb-3">
                          <input type="checkbox" class="form-check-input" [id]="'selectAllUsers-' + deptId"
                            [checked]="selectAllUsersByDept[deptId]" (change)="toggleSelectAllUsers(deptId)"
                            [disabled]="taskForm.value.assignToSelf">
                          <label class="form-check-label" [for]="'selectAllUsers-' + deptId">
                            Select All Users
                          </label>
                        </div>

                        <!-- Users List -->
                        <div class="users-list">
                          <div *ngFor="let user of filteredUsersByDept.get(deptId)" class="user-item">
                            <input type="checkbox" class="form-check-input" [id]="'user-' + user.userId"
                              [checked]="selectedUsersByDeptObj[deptId]?.includes(user.userId)"
                              (change)="updateUserSelection(deptId, user.userId, $event.target.checked)"
                              [disabled]="taskForm.value.assignToSelf ? (user.userId !== currentUser?.userId) : isUserSelectionDisabled(user)">
                            <label [for]="'user-' + user.userId" class="user-label">
                              <div class="user-info">
                                <div class="avatar-sm me-2">
                                  {{ user.fullName.charAt(0) }}
                                </div>
                                <div>
                                  <span class="user-name">{{ user.fullName }}</span>
                                  <small class="user-role">{{ user.role }}</small>
                                </div>
                              </div>
                            </label>
                          </div>

                          <div *ngIf="!(filteredUsersByDept.get(deptId)?.length)" class="empty-state-sm">
                            <i class="bi bi-person-x"></i>
                            <p>No users found</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="quick-actions">
                <div class="row g-2">
                  <div class="col-6">
                    <div class="form-check form-switch">
                      <input type="checkbox" class="form-check-input" id="assignToSelf" formControlName="assignToSelf">
                      <label class="form-check-label" for="assignToSelf">
                        <i class="bi bi-person-check"></i>
                        Assign to Myself
                      </label>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-check form-switch">
                      <input type="checkbox" class="form-check-input" id="isRecurring" formControlName="isRecurring"
                        (change)="onRecurringToggle($event)">
                      <label class="form-check-label" for="isRecurring">
                        <i class="bi bi-arrow-repeat"></i>
                        Recurring
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Schedule -->
          <section class="form-section" id="schedule">
            <div class="section-header">
              <div class="d-flex align-items-center">
                <div class="section-icon">
                  <i class="bi bi-calendar-week"></i>
                </div>
                <div>
                  <h3>Schedule</h3>
                  <p>Set timelines for your task</p>
                </div>
              </div>
            </div>

            <div class="section-body">
              <!-- Start Date -->
              <div class="form-group mb-4" *ngIf="f.status.value === 'UPCOMING'">
                <label class="form-label">
                  <i class="bi bi-calendar-plus"></i>
                  Start Date
                </label>
                <div class="date-picker">
                  <input type="date" class="form-control" formControlName="startDate" [min]="minDate"
                    (change)="onStartDateChange()" [class.is-invalid]="startDateCtrl.touched && (startDateCtrl.errors || startDateErrorMessage)">
                  <i class="bi bi-calendar3"></i>
                </div>
                <div *ngIf="startDateErrorMessage" class="invalid-feedback">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ startDateErrorMessage }}
                </div>
              </div>

              <!-- Due Date -->
              <div class="form-group mb-4">
                <label class="form-label">
                  <i class="bi bi-calendar-check"></i>
                  Due Date <span class="text-danger">*</span>
                </label>
                <div class="date-picker">
                  <input type="date" class="form-control" formControlName="dueDate" [min]="minDate"
                    (change)="onDueDateChange()" [class.is-invalid]="dueDateCtrl.touched && (dueDateCtrl.errors || dueDateErrorMessage)">
                  <i class="bi bi-calendar3"></i>
                </div>
                <div *ngIf="dueDateCtrl.touched && dueDateCtrl.errors?.['required']" class="invalid-feedback">
                  <i class="bi bi-exclamation-circle"></i>
                  Due date is required
                </div>
                <div *ngIf="dueDateErrorMessage" class="invalid-feedback">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ dueDateErrorMessage }}
                </div>
              </div>

              <!-- Info Box -->
              <div class="info-box">
                <i class="bi bi-info-circle"></i>
                <div>
                  <strong>Note:</strong> Sundays are automatically excluded from scheduling.
                  For <strong>Pending</strong> status, due dates cannot be in the past.
                  For <strong>Upcoming</strong> status, start dates must be in the future.
                </div>
              </div>
            </div>
          </section>

          <!-- Empty State -->
          <div *ngIf="!taskForm.value.departmentIds?.length" class="empty-card">
            <i class="bi bi-people"></i>
            <h5>Select Departments First</h5>
            <p>Choose departments from the left panel to enable user assignment</p>
            <!-- <button type="button" class="btn btn-outline-primary" (click)="scrollToSection('departments')">
              <i class="bi bi-arrow-up-left"></i>
              Go to Departments
            </button> -->
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="row align-items-center">
          <div class="col-md-6 mb-3 mb-md-0">
            <div class="validation-status">
              <div *ngIf="taskForm.invalid && taskForm.touched" class="text-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Please fix the errors above before submitting
              </div>
              <div *ngIf="taskForm.valid" class="text-success">
                <i class="bi bi-check-circle"></i>
                All requirements satisfied. Ready to create task!
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex gap-3 justify-content-md-end">
              <button type="button" class="btn btn-outline-secondary" (click)="cancel()" [disabled]="isSubmitting">
                <i class="bi bi-x-circle"></i>
                Cancel
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || taskForm.invalid"
                [class.loading]="isSubmitting">
                <span *ngIf="!isSubmitting">
                  <i class="bi bi-plus-circle"></i>
                  Create Task
                </span>
                <span *ngIf="isSubmitting">
                  <span class="spinner-border spinner-border-sm"></span>
                  Creating...
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </main>
</div>

<!-- Recurring Modal -->
<div class="modal fade" id="recurringModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">
          <i class="bi bi-arrow-repeat"></i>
        </div>
        <div>
          <h5>Configure Recurring Task</h5>
          <p>Set up automatic task repetition</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="recurring-options">
          <div class="option" [class.active]="tempRecurrenceType === 'DAILY'" (click)="tempRecurrenceType = 'DAILY'">
            <div class="option-icon">
              <i class="bi bi-sun"></i>
            </div>
            <div>
              <h6>Daily</h6>
              <small>Repeat every X days</small>
            </div>
          </div>
          <div class="option" [class.active]="tempRecurrenceType === 'WEEKLY'" (click)="tempRecurrenceType = 'WEEKLY'">
            <div class="option-icon">
              <i class="bi bi-calendar-week"></i>
            </div>
            <div>
              <h6>Weekly</h6>
              <small>Repeat every X weeks</small>
            </div>
          </div>
          <div class="option" [class.active]="tempRecurrenceType === 'MONTHLY'"
            (click)="tempRecurrenceType = 'MONTHLY'">
            <div class="option-icon">
              <i class="bi bi-calendar-month"></i>
            </div>
            <div>
              <h6>Monthly</h6>
              <small>Repeat every X months</small>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="bi bi-arrow-repeat"></i>
            Interval
          </label>
          <div class="input-group">
            <input type="number" class="form-control" [(ngModel)]="tempInterval" min="1" max="365" placeholder="Enter interval">
            <span class="input-group-text">
              {{ tempRecurrenceType === 'DAILY' ? 'days' : tempRecurrenceType === 'WEEKLY' ? 'weeks' : 'months' }}
            </span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="bi bi-calendar-x"></i>
            End Date (Optional)
          </label>
          <input type="date" class="form-control" [(ngModel)]="tempEndDate" [min]="minDate">
        </div>

        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i>
          Recurring tasks will be automatically created based on this schedule
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" (click)="onRecurringCancelAdd()">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="onRecurringSubmitAdd()"
          [disabled]="!tempRecurrenceType || tempInterval < 1">
          <i class="bi bi-check-lg"></i>
          Save Settings
        </button>
      </div>
    </div>
  </div>
</div>