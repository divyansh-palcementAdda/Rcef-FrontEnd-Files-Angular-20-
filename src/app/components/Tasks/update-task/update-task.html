<div class="container my-4 my-md-5">
  <div class="card shadow-lg border-0 rounded-4 overflow-hidden animate__animated animate__fadeIn">
    <div class="card-header text-white text-center py-5 table_head sticky-top">
      <h3 class="mb-1 fw-bold animate__animated animate__bounceInDown">Update Task</h3>
      <p class="mb-0 opacity-90">Modify task details and assignments</p>
    </div>

    <div class="card-body p-4 p-md-5 bg-gradient-to-b from-slate-50 to-white">
      <!-- Loading -->
      <div *ngIf="isLoadingTask" class="text-center py-5">
        <div class="spinner-border text-success"></div>
        <p class="mt-3 text-muted">Loading task...</p>
      </div>

      <!-- Messages -->
      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show shadow-sm animate__animated animate__pulse">
        {{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = null"></button>
      </div>
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show shadow-sm animate__animated animate__shakeX">
        {{ errorMessage }}
        <button type="button" class="btn-close" (click)="errorMessage = null"></button>
      </div>

      <!-- Form -->
      <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" novalidate *ngIf="!isLoadingTask">
        <div class="row g-3 g-md-4">

          <!-- Title -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">Task Title <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-emerald-50 text-emerald-700"><i class="bi bi-pencil"></i></span>
              <input type="text" class="form-control" formControlName="title" placeholder="e.g., Q4 Report Update"
                [ngClass]="{ 'is-invalid': f.title.touched && f.title.errors }" />
            </div>
            <div *ngIf="f.title.touched && f.title.errors" class="text-danger small mt-1">
              <small *ngIf="f.title.errors?.required">Title is required.</small>
              <small *ngIf="f.title.errors?.maxlength">Max 255 characters.</small>
              <small *ngIf="f.title.errors?.pattern">Alphanumeric & spaces only.</small>
            </div>
          </div>

          <!-- Description -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">Description</label>
            <div class="input-group">
              <span class="input-group-text bg-emerald-50 text-emerald-700"><i class="bi bi-chat-dots"></i></span>
              <textarea class="form-control" rows="3" formControlName="description"
                placeholder="Provide clear instructions..." [ngClass]="{ 'is-invalid': f.description.touched && f.description.errors }"></textarea>
            </div>
            <div *ngIf="f.description.touched && f.description.errors" class="text-danger small mt-1">
              <small *ngIf="f.description.errors?.maxlength">Max 2000 characters.</small>
            </div>
          </div>

          <!-- Status -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">Status <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-emerald-50 text-emerald-700"><i class="bi bi-tag"></i></span>
              <select class="form-select" formControlName="status"
                [ngClass]="{ 'is-invalid': f.status.touched && f.status.errors }">
                <option [ngValue]="null" disabled>Select status</option>
                <option *ngFor="let s of statuses" [ngValue]="s">{{ s | titlecase }}</option>
              </select>
            </div>
            <div *ngIf="f.status.touched && f.status.errors" class="text-danger small mt-1">
              <small>Status is required.</small>
            </div>
          </div>

          <!-- Start Date -->
          <div class="col-md-6" >
            <label class="form-label fw-semibold text-dark">Start Date</label>
            <div class="input-group clickable" (click)="focusInput($event, startDateInput)">
              <span class="input-group-text bg-emerald-50 text-emerald-700"><i class="bi bi-calendar-plus"></i></span>
              <input #startDateInput type="date" class="form-control" formControlName="startDate"
                [min]="minDate" (change)="onStartDateChange()"
                [ngClass]="{ 'is-invalid': startDateCtrl.touched && dateErrorMessage }" />
            </div>
          </div>

          <!-- Due Date -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">Due Date <span class="text-danger">*</span></label>
            <div class="input-group clickable" (click)="focusInput($event, dueDateInput)">
              <span class="input-group-text bg-emerald-50 text-emerald-700"><i class="bi bi-calendar-check"></i></span>
              <input #dueDateInput type="date" class="form-control" formControlName="dueDate"
                [min]="minDate" (change)="onDueDateChange()"
                [ngClass]="{ 'is-invalid': dueDateCtrl.touched && (dueDateCtrl.errors || dateErrorMessage) }" />
            </div>
            <div *ngIf="dueDateCtrl.touched && dueDateCtrl.errors?.['required']" class="text-danger small mt-1">
              <small>Due date is required.</small>
            </div>
            <div *ngIf="dateErrorMessage" class="text-danger small mt-1">{{ dateErrorMessage }}</div>
          </div>

          <!-- Departments -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">Departments <span class="text-danger">*</span></label>
            <div class="border rounded-3 p-3 bg-white shadow-sm">
              <div class="input-group mb-3">
                <span class="input-group-text bg-emerald-50 text-emerald-700"><i class="bi bi-search"></i></span>
                <input #deptSearchInput id="dept-search" type="text" class="form-control border-0"
                  placeholder="Search departments..." [(ngModel)]="deptSearch" (ngModelChange)="onDeptSearch()"
                  [ngModelOptions]="{standalone: true}" />
                <button *ngIf="deptSearch" type="button" class="btn btn-outline-secondary border-0" (click)="clearDeptSearch()">
                  <i class="bi bi-x"></i>
                </button>
              </div>

              <div class="form-check mb-2">
                <input type="checkbox" class="form-check-input custom-checkbox" id="selectAllDepts"
                  [checked]="selectAllDepts" (change)="toggleSelectAllDepts()"
                  [disabled]="taskForm.value.assignToSelf" />
                <label class="form-check-label fw-bold text-emerald-700" for="selectAllDepts">Select All</label>
              </div>

              <div class="department-list">
                <div *ngIf="isLoadingDepartments" class="p-3">
                  <div class="skeleton-item mb-2" *ngFor="let _ of [1,2,3,4]"></div>
                </div>
                <div *ngIf="!isLoadingDepartments && filteredDepartments.length === 0" class="text-muted small text-center py-3">
                  No departments found
                </div>
                <div *ngFor="let dept of filteredDepartments" class="form-check mb-2">
                  <input type="checkbox" class="form-check-input custom-checkbox"
                    [id]="'dept-' + dept.departmentId"
                    [checked]="taskForm.value.departmentIds.includes(dept.departmentId)"
                    (change)="updateDepartmentSelection(dept.departmentId, $event.target.checked)"
                    [disabled]="taskForm.value.assignToSelf && !currentUser?.departmentIds?.includes(dept.departmentId)" />
                  <label class="form-check-label" [for]="'dept-' + dept.departmentId">
                    {{ dept.name }}
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Users Accordion -->
          <div class="col-md-6" *ngIf="taskForm.value.departmentIds?.length">
            <label class="form-label fw-semibold text-dark">Assign Users</label>

            <div *ngIf="taskForm.value.assignToSelf && currentUser" 
                 class="alert alert-success d-flex align-items-center gap-2 p-3 mb-3 rounded-3 shadow-sm animate__animated animate__fadeIn">
              <i class="bi bi-person-check-fill fs-5 text-emerald-600"></i>
              <div>
                <strong>Task assigned to you:</strong><br>
                <span class="small">
                  {{ currentUser.fullName }}
                  <span class="badge bg-emerald-100 text-emerald-700 ms-1">{{ currentUser.role }}</span>
                  <span *ngIf="currentUser.departmentIds?.length" class="text-muted">
                    â€” {{ getDepartmentNames(currentUser.departmentIds) }}
                  </span>
                </span>
              </div>
            </div>

            <div class="accordion" id="userAccordion">
              <div *ngFor="let deptId of taskForm.value.departmentIds; let i = index" class="accordion-item border-0 shadow-sm mb-3 rounded-3 overflow-hidden">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed fw-semibold text-dark" type="button"
                    data-bs-toggle="collapse" [attr.data-bs-target]="'#collapse-' + deptId">
                    {{ getDepartmentName(deptId) }}
                    <span class="badge bg-emerald-100 text-emerald-700 ms-2">
                      {{ (filteredUsersByDept.get(deptId) || []).length }}
                    </span>
                  </button>
                </h2>
                <div [id]="'collapse-' + deptId" class="accordion-collapse collapse"
                  [class.show]="i === 0" data-bs-parent="#userAccordion">
                  <div class="accordion-body p-3 bg-slate-50">
                    <div class="input-group mb-3">
                      <span class="input-group-text bg-white"><i class="bi bi-search text-emerald-600"></i></span>
                      <input type="text" class="form-control border-0" placeholder="Search users..."
                        [(ngModel)]="userSearchByDept[deptId]" (ngModelChange)="onUserSearch(deptId)"
                        [ngModelOptions]="{standalone: true}" />
                      <button *ngIf="userSearchByDept[deptId]" type="button" class="btn btn-outline-secondary border-0"
                        (click)="clearUserSearch(deptId)">
                        <i class="bi bi-x"></i>
                      </button>
                    </div>

                    <div class="form-check mb-2">
                      <input type="checkbox" class="form-check-input custom-checkbox"
                        [id]="'selectAllUsers-' + deptId" [checked]="selectAllUsersByDept[deptId]"
                        (change)="toggleSelectAllUsers(deptId)"
                        [disabled]="taskForm.value.assignToSelf" />
                      <label class="form-check-label fw-bold text-emerald-700" [for]="'selectAllUsers-' + deptId">
                        Select All
                      </label>
                    </div>

                    <div class="max-h-48 overflow-y-auto">
                      <div *ngFor="let user of filteredUsersByDept.get(deptId)" class="form-check mb-2"
                        [ngClass]="{ 'hod-highlight': user.role === 'HOD' }">
                        <input type="checkbox" class="form-check-input custom-checkbox"
                          [id]="'user-' + user.userId"
                          [checked]="selectedUsersByDeptObj[deptId]?.includes(user.userId)"
                          (change)="updateUserSelection(deptId, user.userId, $event.target.checked)"
                          [disabled]="taskForm.value.assignToSelf ? (user.userId !== currentUser?.userId) : isUserSelectionDisabled(user)" />
                        <label class="form-check-label fw-medium" [for]="'user-' + user.userId">
                          {{ user.fullName }}
                          <small class="text-muted ms-1">({{ user.role }})</small>
                        </label>
                      </div>
                      <div *ngIf="!(filteredUsersByDept.get(deptId)?.length)" class="text-muted small text-center py-2">
                        No users found
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-check mt-4">
              <input type="checkbox" class="form-check-input custom-checkbox" id="assignToSelf" formControlName="assignToSelf" />
              <label class="form-check-label text-emerald-700 fw-medium" for="assignToSelf">
                Assign to Myself
              </label>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex flex-column flex-md-row justify-content-end gap-3 mt-5">
          <button type="button" class="btn btn-outline-secondary px-4 py-2 order-2 order-md-1" (click)="cancel()"
            [disabled]="isSubmitting">Cancel</button>
          <button type="submit" class="btn btn-primary px-5 py-2 d-flex align-items-center gap-2 order-1 order-md-2"
            [disabled]="isSubmitting || taskForm.invalid">
            <span *ngIf="!isSubmitting">Update Task</span>
            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>