<div class="container my-5">

  <!-- Title -->
  <h1 class="text-center mb-4 fw-bold text-white">
    {{ statusFilter ? ('Tasks: ' + statusFilter) : 'All Tasks' }}
  </h1>

  <!-- Card -->
  <div class="card shadow animate__animated animate__fadeIn">
    <div class="card-header py-3 bg-primary text-white rounded-top">
      <h3 class="mb-0 fw-bold">Task Management</h3>
      <small class="text-light">View, filter, and manage tasks efficiently</small>
    </div>

    <div class="card-body px-4 py-4">

      <!-- Alerts -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
        {{ errorMessage }}
        <button type="button" class="btn-close" (click)="errorMessage = null"></button>
      </div>

      <!-- Loading Spinner -->
      <div *ngIf="loading" class="text-center my-5">
        <div class="spinner-border text-primary"></div>
      </div>

      <!-- Filters -->
      <div class="row mb-3 g-2">
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="ğŸ” Search by title, assignee, or department"
            [(ngModel)]="searchTerm" (input)="applyFilters()" />
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
            <option value="">All Statuses</option>
            <option value="PENDING">Pending</option>
            <option value="UPCOMING">Upcoming</option>
            <option value="DELAYED">Delayed</option>
            <option value="REQUEST_FOR_CLOSURE">RFC</option>
            <option value="REQUEST_FOR_EXTENSION">RFE</option>
            <option value="CLOSED">Closed</option>
            <option value="EXTENDED">Extended</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-secondary w-100" (click)="resetFilters()">
            Reset Filters
          </button>
        </div>
      </div>

      <!-- Desktop Table -->
      <div class="table-responsive d-none d-md-block" *ngIf="!loading && paginatedTasks?.length">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Departments & Assignees</th>
              <th>Start Date</th>
              <th>Due Date</th>
              <th>Status</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of paginatedTasks" (click)="viewTaskDetails(task.taskId)" class="cursor-pointer">
              <td>{{ task.taskId }}</td>
              <td>{{ task.title }}</td>

              <!-- âœ… Combined Department + User Logic -->
              <td>
                <ng-container *ngIf="task.departmentNames && task.assignedToNames; else noDeptOrUser">

                  <!-- Multiple departments & multiple users -->
                  <ng-container *ngIf="task.departmentNames.length > 1 && task.assignedToNames.length > 1">
                    <span>Multiple departments and users â€” click View for details.</span>
                  </ng-container>

                  <!-- Multiple departments, single/missing user -->
                  <ng-container *ngIf="task.departmentNames.length > 1 && task.assignedToNames.length <= 1">
                    <span>Multiple departments â€” click View for details.</span>
                  </ng-container>

                  <!-- Single department, multiple users -->
                  <ng-container *ngIf="task.departmentNames.length === 1 && task.assignedToNames.length > 1">
                    <span>
                      {{ task.departmentNames[0] }} â€” multiple assignees, click View for details.
                    </span>
                  </ng-container>

                  <!-- Single department & single user -->
                  <ng-container *ngIf="task.departmentNames.length === 1 && task.assignedToNames.length === 1">
                    <span>
                      {{ task.departmentNames[0] }} â€” {{ task.assignedToNames[0] }}
                    </span>
                  </ng-container>

                  <!-- Single department, unassigned -->
                  <ng-container *ngIf="task.departmentNames.length === 1 && (!task.assignedToNames.length)">
                    <span>
                      {{ task.departmentNames[0] }} â€” Unassigned
                    </span>
                  </ng-container>

                </ng-container>

                <ng-template #noDeptOrUser>â€”</ng-template>
              </td>

             <td>{{ task.startDate | date: 'dd/MM/yyyy' }}</td>
<td>{{ task.dueDate | date: 'dd/MM/yyyy' }}</td>
              <td>
                <span class="badge rounded-pill" [ngClass]="getStatusClass(task.status)">
                  {{ task.status }}
                </span>
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary me-1" (click)="viewTaskDetails(task.taskId)">
                  View
                </button>

               
                  <button *ngIf="task.status !== 'REQUEST_FOR_CLOSURE' && task.status !== 'REQUEST_FOR_EXTENSION'"  class="btn btn-sm btn-outline-danger" (click)="deleteTask($event, task.taskId)">
                    Delete
                  </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Mobile Cards -->
      <div class="d-md-none" *ngIf="!loading && paginatedTasks?.length">
        <div class="row g-3">
          <div class="col-12" *ngFor="let task of paginatedTasks">
            <div class="clickable-card p-3 shadow-sm rounded-3 bg-light" (click)="viewTaskDetails(task.taskId)">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold mb-0">{{ task.title }}</h6>
                <span class="badge rounded-pill" [ngClass]="getStatusClass(task.status)">
                  {{ task.status }}
                </span>
              </div>

              <!-- âœ… Same combined logic for mobile -->
              <p class="mb-1">
                <strong>Department & Users:</strong>
                <ng-container *ngIf="task.departmentNames && task.assignedToNames; else noDeptOrUserM">

                  <ng-container *ngIf="task.departmentNames.length > 1 && task.assignedToNames.length > 1">
                    Multiple departments and users â€” click View for details.
                  </ng-container>

                  <ng-container *ngIf="task.departmentNames.length > 1 && task.assignedToNames.length <= 1">
                    Multiple departments â€” click View for details.
                  </ng-container>

                  <ng-container *ngIf="task.departmentNames.length === 1 && task.assignedToNames.length > 1">
                    {{ task.departmentNames[0] }} â€” multiple assignees, click View for details.
                  </ng-container>

                  <ng-container *ngIf="task.departmentNames.length === 1 && task.assignedToNames.length === 1">
                    {{ task.departmentNames[0] }} â€” {{ task.assignedToNames[0] }}
                  </ng-container>

                  <ng-container *ngIf="task.departmentNames.length === 1 && (!task.assignedToNames.length)">
                    {{ task.departmentNames[0] }} â€” Unassigned
                  </ng-container>

                </ng-container>
                <ng-template #noDeptOrUserM>â€”</ng-template>
              </p>

              <p class="mb-1">
                <strong>Due:</strong> {{ task.dueDate | date: 'short' }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- No Tasks -->
      <div *ngIf="!loading && !paginatedTasks?.length" class="text-center text-muted mt-4">
        No tasks found.
      </div>

      <!-- Pagination -->
      <nav *ngIf="filteredTasks?.length" class="mt-4" aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="changePage(currentPage - 1)">Previous</a>
          </li>
          <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="currentPage === page">
            <a class="page-link" (click)="changePage(page)">{{ page }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="changePage(currentPage + 1)">Next</a>
          </li>
        </ul>
      </nav>
      <button class="btn btn-outline-secondary mb-3" (click)="goBackToDashboard()">
        â† Back to Dashboard
      </button>

    </div>

  </div>
</div>