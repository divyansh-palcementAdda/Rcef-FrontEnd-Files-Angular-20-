<div class="view-tasks-container" [class.loading]="loading">

  <!-- Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner-container">
        <div class="spinner"></div>
        <div class="spinner-inner"></div>
      </div>
      <p class="loading-text">{{ loadingMessage }}</p>
    </div>
  </div>
<br><br><br><br>
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <span class="gradient-text">Task Management</span>
          <span *ngIf="statusFilter" class="filter-badge">
            {{ getFilterDisplayName(statusFilter) }}
          </span>
        </h1>
        <p class="page-description">
          {{ currentUserRole | titlecase }} Dashboard â€¢ 
          <span class="role-badge">{{ currentUserRole }}</span>
          â€¢ Manage and track tasks efficiently
        </p>
      </div>
      
      <div class="header-actions">
        <button class="btn-back" (click)="goBackToDashboard()">
          <span class="icon">â†</span>
          <span>Back to Dashboard</span>
        </button>
      </div>
    </div>
  </div>
  <br>
  <!-- Error States -->
  <div *ngIf="errorMessage" class="error-state">
    <div class="error-content">
      <div class="error-icon">âŒ</div>
      <h3>Unable to Load Tasks</h3>
      <p>{{ errorMessage }}</p>
      <button class="btn-retry" (click)="loadCurrentUserAndTasks()">
        ğŸ”„ Retry Loading
      </button>
    </div>
  </div>

  <div *ngIf="isForbidden" class="error-state">
    <div class="error-content">
      <div class="error-icon">ğŸ”’</div>
      <h3>Access Restricted</h3>
      <p>You don't have permission to view these tasks.</p>
      <button class="btn-back" (click)="goBackToDashboard()">
        â† Return to Dashboard
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !errorMessage && !isForbidden" class="main-content">
    
    <!-- Filters Section -->
    <div class="filters-section">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input 
          type="text" 
          class="search-input"
          placeholder="Search tasks by title, assignee, or department..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
          aria-label="Search tasks"
        />
        <span *ngIf="searchTerm" 
              class="clear-search" 
              (click)="searchTerm = ''; applyFilters()"
              title="Clear search">
          âœ•
        </span>
      </div>
      
      <div class="filter-controls">
        <select class="status-filter" 
                [(ngModel)]="statusFilter" 
                (change)="applyFilters()"
                aria-label="Filter by status">
          <option value="">ğŸ“Š All Statuses</option>
          <option value="PENDING">â³ Pending</option>
          <option value="IN_PROGRESS">â³ In Progress</option>
          <option value="UPCOMING">ğŸ“… Upcoming</option>
          <option value="DELAYED">âš ï¸ Delayed</option>
          <option value="REQUEST_FOR_CLOSURE">ğŸ“ Request for Closure</option>
          <option value="REQUEST_FOR_EXTENSION">â±ï¸ Request for Extension</option>
          <option value="CLOSED">âœ… Closed</option>
          <option value="EXTENDED">ğŸ” Extended</option>
          <option value="SELF">ğŸ‘¤ My Tasks</option>
          <option value="SELFASSIGNED">ğŸ¯ Self Assigned</option>
          <option value="APPROVAL">â³ Awaiting Approval</option>
        </select>
        
        <button class="btn-reset" (click)="resetFilters()">
          <span class="icon">ğŸ”„</span>
          Reset Filters
        </button>
      </div>
    </div>

    <!-- Tasks List -->
    <div *ngIf="!isEmpty && filteredTasks.length > 0" class="tasks-section">
      
      <!-- Desktop Table -->
      <div class="tasks-table desktop-view">
        <div class="table-header">
          <div class="table-row">
            <div class="col-task-id">ID</div>
            <div class="col-title">Task Details</div>
            <div class="col-info">Department & Assignees</div>
            <div class="col-dates">Timeline</div>
            <div class="col-status">Status</div>
            <div class="col-actions">Actions</div>
          </div>
        </div>
        
        <div class="table-body">
          <div *ngFor="let task of paginatedTasks; trackBy: trackByTaskId" 
               class="table-row task-row"
               (click)="viewTaskDetails(task.taskId)"
               [attr.aria-label]="'Task: ' + task.title">
            
            <div class="col-task-id">
              <span class="task-id">#{{ task.taskId }}</span>
            </div>
            
            <div class="col-title">
              <h4 class="task-title">{{ task.title }}</h4>
              <p *ngIf="task.description" class="task-description">
                {{ task.description | slice:0:80 }}{{ task.description.length > 80 ? '...' : '' }}
              </p>
              <p *ngIf="!task.description" class="task-description no-description">
                No description provided
              </p>
            </div>
            
            <div class="col-info">
              <div class="department-info">
                <span class="info-icon">ğŸ¢</span>
                <span *ngIf="task.departmentNames?.length === 1">
                  {{ task.departmentNames?.[0] }}
                </span>
                <span *ngIf="(task.departmentNames?.length ?? 0) > 1" class="multiple">
                  {{ task.departmentNames?.length }} Departments
                </span>
                <span *ngIf="!task.departmentNames?.length" class="unassigned">
                  No Department
                </span>
              </div>
              
              <div class="assignee-info">
                <span class="info-icon">ğŸ‘¤</span>
                <span *ngIf="task.assignedToNames?.length === 1">
                  {{ task.assignedToNames?.[0] }}
                </span>
                <span *ngIf="(task.assignedToNames?.length ?? 0) > 1" class="multiple">
                  {{ task.assignedToNames?.length }} Assignees
                </span>
                <span *ngIf="!task.assignedToNames?.length" class="unassigned">
                  Unassigned
                </span>
              </div>
            </div>
            
            <div class="col-dates">
              <div class="date-item">
                <span class="date-label">Start:</span>
                <span class="date-value">{{ formatDate(task.startDate) }}</span>
              </div>
              <div class="date-item">
                <span class="date-label">Due:</span>
                <span class="date-value">{{ formatDate(task.dueDate) }}</span>
              </div>
            </div>
            
            <div class="col-status">
              <span class="status-badge" [ngClass]="getStatusClass(task.status)">
                <span class="status-icon">{{ getStatusIcon(task.status) }}</span>
                {{ getStatusDisplayName(task.status) }}
              </span>
            </div>
            
            <div class="col-actions">
              <div class="action-buttons">
                <button  *ngIf=" ! canDeleteTask()" class="btn-action btn-view" 
                        (click)="viewTaskDetails(task.taskId); $event.stopPropagation()"
                        aria-label="View task details">
                  ğŸ‘ï¸ View
                </button>
                
                <button *ngIf="canDeleteTask() && task.status !== 'REQUEST_FOR_CLOSURE' && task.status !== 'REQUEST_FOR_EXTENSION'" 
                        class="btn-action btn-delete"
                        (click)="deleteTask($event, task.taskId)"
                        aria-label="Delete task">
                  ğŸ—‘ï¸ Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Cards -->
      <div class="tasks-cards mobile-view">
        <div *ngFor="let task of paginatedTasks; trackBy: trackByTaskId" 
             class="task-card"
             (click)="viewTaskDetails(task.taskId)"
             [attr.aria-label]="'Task: ' + task.title">
          
          <div class="card-header">
            <div class="task-id">#{{ task.taskId }}</div>
            <span class="status-badge" [ngClass]="getStatusClass(task.status)">
              {{ getStatusIcon(task.status) }} {{ getStatusDisplayName(task.status) }}
            </span>
          </div>
          
          <div class="card-body">
            <h4 class="task-title">{{ task.title }}</h4>
            
            <div class="task-info">
              <div class="info-item">
                <span class="info-icon">ğŸ¢</span>
                <span *ngIf="task.departmentNames?.length === 1">
                  {{ task.departmentNames?.[0] }}
                </span>
                <span *ngIf="(task.departmentNames?.length ?? 0) > 1">
                  {{ task.departmentNames?.length }} Depts
                </span>
                <span *ngIf="!task.departmentNames?.length">
                  No Department
                </span>
              </div>

              <div class="info-item">
                <span class="info-icon">ğŸ‘¤</span>
                <span *ngIf="task.assignedToNames?.length === 1">
                  {{ task.assignedToNames?.[0] ?? 'Unassigned' }}
                </span>
                <span *ngIf="(task.assignedToNames?.length ?? 0) > 1">
                  {{ task.assignedToNames?.length }} People
                </span>
                <span *ngIf="!task.assignedToNames?.length">
                  Unassigned
                </span>
              </div>
            </div>
            
            <div class="task-dates">
              <div class="date-item">
                <strong>Start:</strong> {{ formatDate(task.startDate) }}
              </div>
              <div class="date-item">
                <strong>Due:</strong> {{ formatDate(task.dueDate) }}
              </div>
            </div>
          </div>
          
          <div class="card-actions">
            <button class="btn-action btn-view" 
                    (click)="viewTaskDetails(task.taskId); $event.stopPropagation()">
              ğŸ‘ï¸ View
            </button>
            
            <button *ngIf="canDeleteTask() && task.status !== 'REQUEST_FOR_CLOSURE' && task.status !== 'REQUEST_FOR_EXTENSION'" 
                    class="btn-action btn-delete"
                    (click)="deleteTask($event, task.taskId)">
              ğŸ—‘ï¸ Delete
            </button>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div *ngIf="filteredTasks.length > pageSize" class="pagination-section">
        <div class="pagination-info">
          Showing {{ (currentPage - 1) * pageSize + 1 }} to 
          {{ Math.min(currentPage * pageSize, filteredTasks.length) }} of 
          {{ filteredTasks.length }} tasks
        </div>
        
        <div class="pagination-controls">
          <button class="btn-pagination" 
                  [class.disabled]="currentPage === 1"
                  (click)="changePage(currentPage - 1)"
                  [attr.aria-label]="'Previous page'">
            â† Previous
          </button>
          
          <div class="page-numbers">
            <button *ngFor="let page of getPageNumbers()" 
                    class="page-number"
                    [class.active]="currentPage === page"
                    (click)="changePage(page)"
                    [attr.aria-label]="'Page ' + page"
                    [attr.aria-current]="currentPage === page ? 'page' : null">
              {{ page }}
            </button>
          </div>
          
          <button class="btn-pagination" 
                  [class.disabled]="currentPage === totalPages"
                  (click)="changePage(currentPage + 1)"
                  [attr.aria-label]="'Next page'">
            Next â†’
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="isEmpty || filteredTasks.length === 0" class="empty-state">
      <div class="empty-content">
        <div class="empty-icon">ğŸ“­</div>
        <h3>No Tasks Found</h3>
        <p *ngIf="searchTerm || statusFilter">
          No tasks match your current filters. Try adjusting your search criteria.
        </p>
        <p *ngIf="!searchTerm && !statusFilter">
          {{ currentUserRole === 'TEACHER' ? 'No tasks are assigned to you yet.' : 
             currentUserRole === 'HOD' ? 'No tasks found in your departments.' : 
             'No tasks available in the system.' }}
        </p>
        <button *ngIf="searchTerm || statusFilter" class="btn-reset" (click)="resetFilters()">
          ğŸ—‘ï¸ Clear All Filters
        </button>
        <button *ngIf="!searchTerm && !statusFilter" class="btn-back" (click)="goBackToDashboard()">
          â† Return to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>