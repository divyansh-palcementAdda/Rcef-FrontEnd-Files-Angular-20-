<div class="container my-4 my-md-5">
  <div class="card shadow-lg border-0 rounded-4 overflow-hidden animate_animated animate_fadeIn">
    <!-- Sticky Gradient Header -->
    <div class="card-header text-white text-center py-5 table_head sticky-top">
      <h3 class="mb-1 fw-bold animate_animated animate_bounceInDown">
        Create New Task
      </h3>
      <p class="mb-0 opacity-90">
        Define task details, assign responsible teams and users, and set clear timelines.
      </p>
    </div>

    <div class="card-body p-4 p-md-5 bg-gradient-to-b from-slate-50 to-white">
      <!-- Success/Error -->
      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show shadow-sm">
        {{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = null"></button>
      </div>
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show shadow-sm">
        {{ errorMessage }}
        <button type="button" class="btn-close" (click)="errorMessage = null"></button>
      </div>

      <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" novalidate>
        <div class="row g-3 g-md-4">
          <!-- ================= TITLE ================= -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">
              Task Title <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <span class="input-group-text bg-emerald-50 text-emerald-700">
                <i class="bi bi-pencil"></i>
              </span>
              <input
                type="text"
                class="form-control"
                formControlName="title"
                placeholder="e.g., Prepare Monthly Attendance Report"
                [ngClass]="{ 'is-invalid': f.title.touched && f.title.errors }"
              />
            </div>
            <div class="field-hint">
              Use a short, action-oriented title that clearly summarizes the task outcome.
            </div>
            <div *ngIf="f.title.touched && f.title.errors" class="text-danger small mt-1">
              <small *ngIf="f.title.errors?.required">Title is required.</small>
              <small *ngIf="f.title.errors?.maxlength">Max 255 characters allowed.</small>
              <small *ngIf="f.title.errors?.pattern">Only letters, numbers and spaces are allowed.</small>
            </div>
          </div>

          <!-- =============== DESCRIPTION =============== -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">
              Description
            </label>
            <div class="input-group">
              <span class="input-group-text bg-emerald-50 text-emerald-700">
                <i class="bi bi-chat-dots"></i>
              </span>
              <textarea
                class="form-control"
                rows="3"
                formControlName="description"
                placeholder="Provide clear instructions, context, dependencies and expected outcomes..."
                [ngClass]="{ 'is-invalid': f.description.touched && f.description.errors }"
              ></textarea>
            </div>
            <div class="field-hint">
              Add a concise but complete description so assignees understand scope, context, and expectations.
            </div>
            <div *ngIf="f.description.touched && f.description.errors" class="text-danger small mt-1">
              <small *ngIf="f.description.errors?.maxlength">Max 2000 characters allowed.</small>
            </div>
          </div>

          <!-- ================= STATUS ================= -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">
              Status <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <span class="input-group-text bg-emerald-50 text-emerald-700">
                <i class="bi bi-tag"></i>
              </span>
              <select
                class="form-select"
                formControlName="status"
                [ngClass]="{ 'is-invalid': f.status.touched && f.status.errors }"
              >
                <option [ngValue]="null" disabled>Select status</option>
                <option *ngFor="let s of statuses" [ngValue]="s">
                  {{ s | titlecase }}
                </option>
              </select>
            </div>
            <div class="field-hint">
              <span class="d-block">
                <strong>UPCOMING</strong> – Task is planned and will start in the future (requires a future start date).
              </span>
              <span class="d-block">
                <strong>PENDING</strong> – Task is active or can be worked on immediately (due date cannot be in the past).
              </span>
            </div>
            <div *ngIf="f.status.touched && f.status.errors" class="text-danger small mt-1">
              <small>Status is required.</small>
            </div>
          </div>

          <!-- ==================== DUE DATE ==================== -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">
              Due Date <span class="text-danger">*</span>
            </label>

            <div
              class="input-group clickable"
              (click)="focusInput($event, dueDateInput)"
            >
              <span class="input-group-text bg-emerald-50 text-emerald-700">
                <i class="bi bi-calendar-check"></i>
              </span>

              <input
                #dueDateInput
                type="date"
                class="form-control"
                formControlName="dueDate"
                [min]="minDate"
                (change)="onDueDateChange()"
                [ngClass]="{
                  'is-invalid': dueDateCtrl.touched && (dueDateCtrl.errors || dueDateErrorMessage)
                }"
              />
            </div>
            <div class="field-hint">
              Choose the final completion date for this task. The due date must not be before the start date, cannot be a Sunday, and cannot be in the past.
            </div>
            <!-- Required error -->
            <div
              *ngIf="dueDateCtrl.touched && dueDateCtrl.errors?.['required']"
              class="text-danger small mt-1"
            >
              <small>Due date is required.</small>
            </div>

            <!-- Custom date-logic error -->
            <div *ngIf="dueDateErrorMessage" class="text-danger small mt-1">
              {{ dueDateErrorMessage }}
            </div>
          </div>

          <!-- ==================== START DATE (UPCOMING only) ==================== -->
          <div class="col-md-6" *ngIf="f.status.value === 'UPCOMING'">
            <label class="form-label fw-semibold text-dark">
              Start Date
            </label>

            <div
              class="input-group clickable"
              (click)="focusInput($event, startDateInput)"
            >
              <span class="input-group-text bg-emerald-50 text-emerald-700">
                <i class="bi bi-calendar-plus"></i>
              </span>

              <input
                #startDateInput
                type="date"
                class="form-control"
                formControlName="startDate"
                [min]="minDate"
                (change)="onStartDateChange()"
                [ngClass]="{
                  'is-invalid': startDateCtrl.touched && (startDateCtrl.errors || startDateErrorMessage)
                }"
              />
            </div>
            <div class="field-hint">
              For <strong>UPCOMING</strong> tasks, select the date work is expected to begin. The start date must be a future working day (Monday–Saturday) and not a Sunday.
            </div>
            <div *ngIf="startDateErrorMessage" class="text-danger small mt-1">
              {{ startDateErrorMessage }}
            </div>
          </div>

          <!-- ==================== DEPARTMENTS ==================== -->
          <div class="col-md-6">
            <label class="form-label fw-semibold text-dark">
              Departments <span class="text-danger">*</span>
            </label>
            <div class="border rounded-3 p-3 bg-white shadow-sm department-wrapper">
              <div class="input-group mb-2">
                <span class="input-group-text bg-emerald-50 text-emerald-700">
                  <i class="bi bi-search"></i>
                </span>
                <input
                  #deptSearchInput
                  id="dept-search"
                  type="text"
                  class="form-control border-0"
                  placeholder="Search departments..."
                  [(ngModel)]="deptSearch"
                  (ngModelChange)="onDeptSearch()"
                  [ngModelOptions]="{standalone: true}"
                />
                <button
                  *ngIf="deptSearch"
                  type="button"
                  class="btn btn-outline-secondary border-0"
                  (click)="clearDeptSearch()"
                >
                  <i class="bi bi-x"></i>
                </button>
              </div>
              <div class="field-hint mb-2">
                Filter the department list by name to quickly find the teams that should be responsible for this task.
              </div>

              <!-- Select All Depts -->
              <div class="form-check mb-2">
                <input
                  type="checkbox"
                  class="form-check-input custom-checkbox"
                  id="selectAllDepts"
                  [checked]="selectAllDepts"
                  (change)="toggleSelectAllDepts()"
                  [disabled]="taskForm.value.assignToSelf"
                />
                <label
                  class="form-check-label fw-bold text-emerald-700"
                  for="selectAllDepts"
                >
                  Select All
                </label>
              </div>
              <div class="field-hint mb-2">
                Use “Select All” to assign the task to every listed department, or choose only those that are directly involved.
              </div>

              <div class="department-list">
                <div *ngIf="isLoadingDepartments" class="p-3">
                  <div class="skeleton-item mb-2" *ngFor="let _ of [1, 2, 3, 4]"></div>
                </div>
                <div
                  *ngIf="!isLoadingDepartments && filteredDepartments.length === 0"
                  class="text-muted small text-center py-3"
                >
                  No departments found
                </div>
                <div *ngFor="let dept of filteredDepartments" class="form-check mb-2">
                  <input
                    type="checkbox"
                    class="form-check-input custom-checkbox"
                    [id]="'dept-' + dept.departmentId"
                    [checked]="taskForm.value.departmentIds.includes(dept.departmentId)"
                    (change)="updateDepartmentSelection(dept.departmentId, $event.target.checked)"
                    [disabled]="
                      taskForm.value.assignToSelf &&
                      !currentUser?.departmentIds?.includes(dept.departmentId)
                    "
                  />
                  <label
                    class="form-check-label"
                    [for]="'dept-' + dept.departmentId"
                  >
                    {{ dept.name }}
                  </label>
                </div>
              </div>

              <div class="field-hint mt-2">
                Select at least one department. Tasks will be visible to and assignable within the departments you choose.
              </div>
            </div>
          </div>

          <!-- ==================== USERS / ASSIGNMENT ==================== -->
          <div class="col-md-6" *ngIf="taskForm.value.departmentIds?.length">
            <label class="form-label fw-semibold text-dark">
              Assign Users
            </label>
            <div class="field-hint mb-2">
              Choose specific users within the selected departments who will be responsible for completing this task.
            </div>

            <!-- SELF-ASSIGN SUCCESS MESSAGE -->
            <div
              *ngIf="taskForm.value.assignToSelf && currentUser"
              class="alert alert-success d-flex align-items-center gap-2 p-3 mb-3 rounded-3 shadow-sm animate_animated animate_fadeIn"
            >
              <i class="bi bi-person-check-fill fs-5 text-emerald-600"></i>
              <div>
                <strong>Task assigned to you:</strong><br />
                <span class="small">
                  {{ currentUser.fullName }}
                  <span class="badge bg-emerald-100 text-emerald-700 ms-1">
                    {{ currentUser.role }}
                  </span>
                  <span
                    *ngIf="currentUser.departmentIds?.length"
                    class="text-muted"
                  >
                    — {{ getDepartmentNames(currentUser.departmentIds) }}
                  </span>
                </span>
              </div>
            </div>

            <div class="accordion" id="userAccordion">
              <div
                *ngFor="let deptId of taskForm.value.departmentIds; let i = index"
                class="accordion-item border-0 shadow-sm mb-3 rounded-3 overflow-hidden"
              >
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed fw-semibold text-dark"
                    type="button"
                    data-bs-toggle="collapse"
                    [attr.data-bs-target]="'#collapse-' + deptId"
                  >
                    {{ getDepartmentName(deptId) }}
                    <span class="badge bg-emerald-100 text-emerald-700 ms-2">
                      {{ (filteredUsersByDept.get(deptId) || []).length }}
                    </span>
                  </button>
                </h2>
                <div
                  [id]="'collapse-' + deptId"
                  class="accordion-collapse collapse"
                  [class.show]="i === 0"
                  data-bs-parent="#userAccordion"
                >
                  <div class="accordion-body p-3 bg-slate-50">
                    <div class="input-group mb-2">
                      <span class="input-group-text bg-white">
                        <i class="bi bi-search text-emerald-600"></i>
                      </span>
                      <input
                        type="text"
                        class="form-control border-0"
                        placeholder="Search users by name or username..."
                        [(ngModel)]="userSearchByDept[deptId]"
                        (ngModelChange)="onUserSearch(deptId)"
                        [ngModelOptions]="{standalone: true}"
                      />
                      <button
                        *ngIf="userSearchByDept[deptId]"
                        type="button"
                        class="btn btn-outline-secondary border-0"
                        (click)="clearUserSearch(deptId)"
                      >
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                    <div class="field-hint mb-2">
                      Start typing to quickly locate users within this department. Only active users are listed.
                    </div>

                    <!-- Select All Users in Dept -->
                    <div class="form-check mb-2">
                      <input
                        type="checkbox"
                        class="form-check-input custom-checkbox"
                        [id]="'selectAllUsers-' + deptId"
                        [checked]="selectAllUsersByDept[deptId]"
                        (change)="toggleSelectAllUsers(deptId)"
                        [disabled]="taskForm.value.assignToSelf"
                      />
                      <label
                        class="form-check-label fw-bold text-emerald-700"
                        [for]="'selectAllUsers-' + deptId"
                      >
                        Select All
                      </label>
                    </div>
                    <div class="field-hint mb-2">
                      Use “Select All” to assign the task to all eligible users in this department. When “Assign to Myself” is enabled, only your own user record can be selected.
                    </div>

                    <div class="max-h-48 overflow-y-auto">
                      <div
                        *ngFor="let user of filteredUsersByDept.get(deptId)"
                        class="form-check mb-2"
                        [ngClass]="{ 'hod-highlight': user.role === 'HOD' }"
                      >
                        <input
                          type="checkbox"
                          class="form-check-input custom-checkbox"
                          [id]="'user-' + user.userId"
                          [checked]="selectedUsersByDeptObj[deptId]?.includes(user.userId)"
                          (change)="updateUserSelection(deptId, user.userId, $event.target.checked)"
                          [disabled]="
                            taskForm.value.assignToSelf
                              ? (user.userId !== currentUser?.userId)
                              : isUserSelectionDisabled(user)
                          "
                        />
                        <label
                          class="form-check-label fw-medium"
                          [for]="'user-' + user.userId"
                        >
                          {{ user.fullName }}
                          <small class="text-muted ms-1">({{ user.role }})</small>
                        </label>
                      </div>
                      <div
                        *ngIf="!(filteredUsersByDept.get(deptId)?.length)"
                        class="text-muted small text-center py-2"
                      >
                        No users found
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Assign to Self Checkbox -->
            <div class="form-check mt-4">
              <input
                type="checkbox"
                class="form-check-input custom-checkbox"
                id="assignToSelf"
                formControlName="assignToSelf"
              />
              <label
                class="form-check-label text-emerald-700 fw-medium"
                for="assignToSelf"
              >
                Assign to Myself
              </label>
            </div>
            <div class="field-hint mt-1">
              Enable this option to automatically assign the task to you in your own departments. Other user selections will be restricted accordingly.
            </div>
          </div>
        </div>

        <!-- =============== BUTTONS =============== -->
        <div class="d-flex flex-column flex-md-row justify-content-end gap-3 mt-5">
          <button
            type="button"
            class="btn btn-outline-secondary px-4 py-2 order-2 order-md-1"
            (click)="cancel()"
            [disabled]="isSubmitting"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary px-5 py-2 d-flex align-items-center gap-2 order-1 order-md-2"
            [disabled]="isSubmitting || taskForm.invalid"
          >
            <span *ngIf="!isSubmitting">Create Task</span>
            <span
              *ngIf="isSubmitting"
              class="spinner-border spinner-border-sm"
              role="status"
            ></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>