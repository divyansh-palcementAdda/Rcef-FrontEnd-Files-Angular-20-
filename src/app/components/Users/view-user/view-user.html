<div class="container py-5">
  <!-- Forbidden -->
  <div *ngIf="isForbidden" class="alert alert-danger text-center shadow-lg rounded-4 py-5 fade-in">
    <i class="bi bi-shield-lock fs-1 mb-4 text-danger"></i>
    <h4 class="fw-bold">Access Denied</h4>
    <p class="lead text-muted">You do not have permission to view this user.</p>
    <button class="btn btn-outline-danger rounded-pill px-5 py-3 mt-3" (click)="goBack()">
      <i class="bi bi-arrow-left me-2"></i>Go Back
    </button>
  </div>

  <!-- Error -->
  <div *ngIf="errorMessage && !isForbidden" class="alert alert-danger rounded-pill py-3 text-center fw-semibold mb-5 fade-in">
    {{ errorMessage }}
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" style="width: 3.5rem; height: 3.5rem;"></div>
    <p class="mt-4 fw-medium text-muted lead">Loading user profile...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="user && !isLoading && !isForbidden" class="user-card fade-in">
    <!-- Header -->
    <div class="user-header">
      <h3 class="fw-bold display-5 mb-2">{{ user.fullName }}</h3>
      <div class="badges">
        <span class="badge role-badge" [ngClass]="{
          'role-hod': user.role === 'HOD',
          'role-user': user.role === 'USER',
          'role-admin': user.role === 'ADMIN',
          'role-super': user.role === 'SUPER_ADMIN'
        }">{{ user.role }}</span>
        <span class="badge status-badge ms-3" [ngClass]="{
          'bg-success': user.status === 'ACTIVE',
          'bg-secondary': user.status === 'INACTIVE'
        }">{{ user.status }}</span>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="info-grid">
      <div>
        <p><i class="bi bi-person-circle me-3 icon"></i><strong>Username:</strong> {{ user.username }}</p>
        <p><i class="bi bi-envelope me-3 icon"></i><strong>Email:</strong> {{ user.email }}</p>
        <p><i class="bi bi-building me-3 icon"></i><strong>Departments:</strong> {{ user.departmentNames || 'N/A' }}</p>
      </div>
      <div>
        <p><i class="bi bi-shield-check me-3 icon"></i><strong>Email Verified:</strong>
          <span [class.text-success]="user.emailVerified" [class.text-danger]="!user.emailVerified" class="fw-semibold">
            {{ user.emailVerified ? 'Yes' : 'No' }}
          </span>
        </p>
      </div>
    </div>

    <!-- Task Stats -->
    <div class="stats-grid">
      <div class="stat-card hover-lift" *ngFor="let stat of taskStats"
           (click)="statusFilter = stat.label.toUpperCase(); applyFilters(); toggleCollapse('tasks')">
        <h4 class="count text-{{ stat.color }}">{{ stat.count }}</h4>
        <small class="label">{{ stat.label }}</small>
      </div>
    </div>

    <!-- Collapsible Sections Buttons -->
    <div class="section-buttons">
      <button class="btn btn-outline-primary" (click)="toggleCollapse('tasks')">
        <i class="bi bi-list-task me-2"></i>{{ collapsed.tasks ? 'Show' : 'Hide' }} Tasks ({{ userTasks.length }})
      </button>
      <button class="btn btn-outline-info" (click)="toggleCollapse('departments')">
        <i class="bi bi-diagram-3 me-2"></i>{{ collapsed.departments ? 'Show' : 'Hide' }} Departments ({{ enrichedDepartments.length }})
      </button>
      <button class="btn btn-outline-secondary" (click)="toggleCollapse('logs')">
        <i class="bi bi-clock-history me-2"></i>{{ collapsed.logs ? 'Show' : 'Hide' }} Logs ({{ userLogs.length || '—' }})
      </button>
    </div>

    <!-- Tasks Table -->
    <div *ngIf="!collapsed.tasks" class="section-card mt-5">
      <div class="section-header tasks-header">
        <i class="bi bi-list-task me-2"></i>Assigned Tasks ({{ filteredTasks.length }})
      </div>
      <div class="section-body">
        <div class="search-bar mb-4">
          <input type="text" class="form-control" placeholder="Search tasks..." [(ngModel)]="searchTerm" (input)="applyFilters()">
          <button class="btn btn-outline-secondary ms-3" (click)="resetFilters()">Reset</button>
        </div>

        <div class="table-responsive" *ngIf="paginatedTasks.length">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let task of paginatedTasks">
                <td>{{ task.taskId }}</td>
                <td>{{ task.title }}</td>
                <td>
                  <span class="status-badge" [ngClass]="getTaskStatusClass(task.status)">
                    {{ task.status.replace('_', ' ') }}
                  </span>
                </td>
                <td>{{ task.dueDate | date:'mediumDate' }}</td>
                <td>
                  <button class="btn btn-sm btn-primary" (click)="viewTask(task.taskId)">
                    <i class="bi bi-eye"></i> View
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <!-- Pagination -->
          <nav *ngIf="filteredTasks.length > pageSize" class="pagination-wrapper">
            <ul class="pagination">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <a class="page-link" (click)="changePage(currentPage - 1)">Previous</a>
              </li>
              <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="currentPage === page">
                <a class="page-link" (click)="changePage(page)">{{ page }}</a>
              </li>
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <a class="page-link" (click)="changePage(currentPage + 1)">Next</a>
              </li>
            </ul>
          </nav>
        </div>
        <div *ngIf="!paginatedTasks.length" class="empty-state">
          <i class="bi bi-clipboard-x fs-1"></i>
          <p>No tasks found.</p>
        </div>
      </div>
    </div>

    <!-- Departments Table -->
    <div *ngIf="!collapsed.departments" class="section-card mt-5">
      <div class="section-header depts-header">
        <i class="bi bi-diagram-3 me-2"></i>Departments ({{ enrichedDepartments.length }})
      </div>
      <div class="section-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Name</th>
                <th>HOD</th>
                <th>Total Users</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let dept of enrichedDepartments">
                <td>{{ dept.name }}</td>
                <td>{{ dept.hodName }}</td>
                <td><span class="badge bg-primary rounded-pill">{{ dept.userCount }}</span></td>
                <td>
                  <button class="btn btn-sm btn-info" (click)="viewDepartment(dept.id)">
                    <i class="bi bi-eye"></i> View
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="!enrichedDepartments.length" class="empty-state">
          <i class="bi bi-building-x fs-1"></i>
          <p>No departments assigned.</p>
        </div>
      </div>
    </div>

    <!-- Logs Table -->
    <div *ngIf="!collapsed.logs" class="section-card mt-5">
      <div class="section-header logs-header">
        <i class="bi bi-clock-history me-2"></i>User Audit Logs ({{ filteredLogs.length }})
      </div>
      <div class="section-body">
        <div class="search-bar mb-4">
          <input type="text" class="form-control" placeholder="Search logs..." [(ngModel)]="searchTermLogs" (input)="applyFiltersLogs()">
          <button class="btn btn-outline-secondary ms-3" (click)="resetFiltersLogs()">Reset</button>
        </div>

        <div class="table-responsive" *ngIf="paginatedLogs.length">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Action</th>
                <th>Entity</th>
                <th>Entity ID</th>
                <th>Timestamp</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of paginatedLogs">
                <td>{{ log.logId }}</td>
                <td><code>{{ log.action }}</code></td>
                <td>{{ log.entity }}</td>
                <td>{{ log.entityId }}</td>
                <td>{{ log.timestamp | date:'medium' }}</td>
                <td class="text-muted">{{ log.details || '—' }}</td>
              </tr>
            </tbody>
          </table>
          <!-- Pagination -->
          <nav *ngIf="filteredLogs.length > pageSizeLogs" class="pagination-wrapper">
            <ul class="pagination">
              <li class="page-item" [class.disabled]="currentPageLogs === 1">
                <a class="page-link" (click)="changePageLogs(currentPageLogs - 1)">Previous</a>
              </li>
              <li class="page-item" *ngFor="let page of getPageNumbersLogs()" [class.active]="currentPageLogs === page">
                <a class="page-link" (click)="changePageLogs(page)">{{ page }}</a>
              </li>
              <li class="page-item" [class.disabled]="currentPageLogs === totalPagesLogs">
                <a class="page-link" (click)="changePageLogs(currentPageLogs + 1)">Next</a>
              </li>
            </ul>
          </nav>
        </div>
        <div *ngIf="!paginatedLogs.length" class="empty-state">
          <i class="bi bi-journal-x fs-1"></i>
          <p>No logs available.</p>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons mt-5">
      <button *ngIf="canEditDelete()" class="btn btn-outline-primary" (click)="editUser()">
        <i class="bi bi-pencil-square me-2"></i>Edit User
      </button>
      <button *ngIf="canEditDelete() && user?.status === 'ACTIVE'" class="btn btn-outline-danger" (click)="deleteUser()">
        <i class="bi bi-trash me-2"></i>Delete User
      </button>
      <button *ngIf="canEditDelete() && user?.status === 'INACTIVE'" class="btn btn-success" (click)="toggleUserStatus()">
        <i class="bi bi-check-circle me-2"></i>Activate User
      </button>
      <button class="btn btn-primary shadow-lg" (click)="assignNewTask()">
        <i class="bi bi-plus-circle me-2"></i>Assign New Task
      </button>
      <button class="btn btn-outline-secondary" (click)="goBack()">
        <i class="bi bi-arrow-left-circle me-2"></i>Back
      </button>
    </div>
  </div>
</div>