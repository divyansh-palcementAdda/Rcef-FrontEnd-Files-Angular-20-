<div class="container my-5">

  <!-- ðŸ”´ Error -->
  <div *ngIf="errorMessage" class="alert alert-danger text-center shadow-sm">
    {{ errorMessage }}
  </div>

  <!-- ðŸ”µ Loading -->
  <div *ngIf="loadingUser" class="text-center my-5">
    <div class="spinner-border text-primary"></div>
    <p class="mt-2">Loading user details...</p>
  </div>

  <!-- ðŸ§ User Info -->
  <div *ngIf="user && !loadingUser" class="card shadow rounded-4 border-0 animate__animated animate__fadeIn">
    <div class="card-header text-white text-center table_head">
      <h3 class="fw-bold mb-0">{{ user.fullName }}</h3>
      <small class="text-light-50">User Profile</small>
    </div>

    <div class="card-body p-4">
      <div class="row g-3">
        <div class="col-md-6">
          <p><strong>Username:</strong> {{ user.username }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Role:</strong> {{ user.role }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Status:</strong>
            <span class="badge rounded-pill" [ngClass]="{
              'bg-success': user.status === 'ACTIVE',
              'bg-secondary': user.status === 'INACTIVE'
            }">{{ user.status }}</span>
          </p>

          <p><strong>Department:</strong> {{ user.departmentName || 'N/A' }}</p>

          <p><strong>Email Verified:</strong>
            <span [ngClass]="user.emailVerified ? 'text-success fw-semibold' : 'text-danger fw-semibold'">
              {{ user.emailVerified ? 'Yes' : 'No' }}
            </span>
          </p>
        </div>
      </div>

      <!-- ðŸ§® Task Counters (Clickable) -->
      <div class="row mt-3 text-center">
        <div class="col-6 col-md-3 mb-2" *ngIf="user" (click)="filterByStatus('PENDING')" style="cursor:pointer;">
          <div class="p-3 bg-light rounded shadow-sm hover-scale">
            <h5 class="mb-0">{{ user.pendingTasks || 0 }}</h5>
            <small>Pending</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-2" *ngIf="user" (click)="filterByStatus('UPCOMING')" style="cursor:pointer;">
          <div class="p-3 bg-light rounded shadow-sm hover-scale">
            <h5 class="mb-0">{{ user.upcomingTasks || 0 }}</h5>
            <small>Upcoming</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-2" *ngIf="user" (click)="filterByStatus('DELAYED')" style="cursor:pointer;">
          <div class="p-3 bg-light rounded shadow-sm hover-scale">
            <h5 class="mb-0">{{ user.delayedTasks || 0 }}</h5>
            <small>Delayed</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-2" *ngIf="user" (click)="filterByStatus('CLOSED')" style="cursor:pointer;">
          <div class="p-3 bg-light rounded shadow-sm hover-scale">
            <h5 class="mb-0">{{ user.closedTasks || 0 }}</h5>
            <small>Closed</small>
          </div>
        </div>
      </div>

      <!-- ðŸ§­ Action Buttons -->
      <div class="text-center mt-4 d-flex justify-content-center flex-wrap gap-2">
        <button class="btn btn-outline-primary px-4" (click)="editUser()">
          <i class="bi bi-pencil"></i> Edit
        </button>

        <button *ngIf="user.status === 'ACTIVE'" class="btn btn-outline-danger px-4" (click)="deleteUser()">
          <i class="bi bi-person-trash"></i> Delete
        </button>

        <button *ngIf="user.status === 'INACTIVE'" class="btn btn-outline-success px-4" (click)="toggleUserStatus()">
          <i class="bi bi-person-check"></i> Activate
        </button>
      </div>
    </div>
  </div>

  <!-- ðŸ” Task Filter & Table -->
  <div class="card shadow rounded-4 border-0 mt-5" *ngIf="userTasks?.length">
    <div class="card-header table_head text-center">
      <h4 class="fw-bold mb-0">Assigned Tasks</h4>
    </div>

    <div class="card-body px-4 py-3">
      <!-- Search & Reset -->
      <div class="row mb-3 g-2">
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="Search tasks by title"
            [(ngModel)]="searchTerm" (input)="applyFilters()">
        </div>
        <div class="col-md-6">
          <button class="btn btn-outline-secondary w-100" (click)="resetFilters()">Reset Filters</button>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="loadingTasks" class="text-center my-3">
        <div class="spinner-border text-primary"></div>
      </div>

      <!-- Table -->
      <div class="table-responsive" *ngIf="!loadingTasks && paginatedTasks?.length">
        <table class="table table-borderless align-middle mb-0">
          <thead class="table_head">
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Status</th>
              <th>Due Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of paginatedTasks">
              <td>{{ task.taskId }}</td>
              <td>{{ task.title }}</td>
              <td>
                <span class="badge rounded-pill" [ngClass]="{
                    'bg-warning text-dark': task.status === 'PENDING' || task.status === 'UPCOMING',
                    'bg-danger blink': task.status === 'DELAYED',
                    'bg-info': task.status === 'REQUEST_FOR_CLOSURE' || task.status === 'REQUEST_FOR_EXTENSION',
                    'bg-success': task.status === 'CLOSED'
                  }">{{ task.status }}</span>
              </td>
              <td>{{ task.dueDate | date: 'mediumDate' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No Tasks -->
      <div *ngIf="!loadingTasks && !paginatedTasks?.length" class="text-center text-muted mt-4">
        <i class="bi bi-clipboard-x"></i> No tasks match the filter.
      </div>

      <!-- Pagination -->
<nav *ngIf="(filteredTasks?.length || 0) > pageSize" class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link"style="cursor: pointer;" (click)="changePage(currentPage - 1)">Previous</a>
          </li>
          <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="currentPage === page">
            <a class="page-link" (click)="changePage(page)">{{ page }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="changePage(currentPage + 1)">Next</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- âšª No Tasks Message -->
  <div *ngIf="!loadingTasks && !userTasks?.length" class="text-center text-muted mt-4">
    <i class="bi bi-clipboard-x"></i> No tasks assigned to this user.
  </div>
</div>
