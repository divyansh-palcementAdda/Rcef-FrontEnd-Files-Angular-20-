<br><br><br>
<div class="user-profile-container">
  <!-- Loading Overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p class="loading-text">Loading user profile...</p>
    </div>
  </div>

  <!-- Forbidden State -->
  <div *ngIf="isForbidden && !isLoading" class="forbidden-container">
    <div class="forbidden-card">
      <div class="forbidden-icon">
        <i class="bi bi-shield-fill-exclamation"></i>
      </div>
      <h2>Access Restricted</h2>
      <p>You don't have sufficient permissions to view this user's details.</p>
      <button class="btn-back" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Return to Users
      </button>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading && !isForbidden" class="error-container">
    <div class="error-alert">
      <i class="bi bi-exclamation-octagon"></i>
      <div class="error-content">
        <h3>Error Loading Profile</h3>
        <p>{{ errorMessage }}</p>
      </div>
      <button class="btn-error-close" (click)="errorMessage = ''">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="user && !isLoading && !isForbidden" class="main-content">
    
    <!-- Top Header -->
    <div class="top-header">
      <div class="breadcrumb">
        <button class="breadcrumb-back" (click)="goBack()">
          <i class="bi bi-chevron-left"></i>
          <span>All Users</span>
        </button>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">User Profile</span>
      </div>
      
      <div class="header-actions">
        <button class="btn-icon" title="Refresh" (click)="loadUserDetails()">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button class="btn-action assign-task" (click)="assignNewTask()">
          <i class="bi bi-plus-lg"></i>
          <span>Assign Task</span>
        </button>
      </div>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar">
        <div class="avatar-wrapper">
          <div class="avatar-circle">
            {{ user.fullName.charAt(0) }}
          </div>
          <div class="status-indicator" [ngClass]="'status-' + user.status.toLowerCase()"></div>
        </div>
        
        <div class="profile-info">
          <div class="profile-name-section">
            <h1 class="profile-name">{{ user.fullName }}</h1>
            <div class="profile-badges">
              <span class="badge-role" [ngClass]="'role-' + user.role.toLowerCase()">
                <i class="bi bi-person-badge"></i>
                {{ user.role.replace('_', ' ') }}
              </span>
              <span class="badge-status" [ngClass]="'badge-' + user.status.toLowerCase()">
                <i class="bi bi-circle-fill"></i>
                {{ user.status }}
              </span>
            </div>
          </div>
          
          <div class="profile-meta">
            <div class="meta-item">
              <i class="bi bi-person"></i>
              <div>
                <span class="meta-label">Username</span>
                <span class="meta-value">@{{ user.username }}</span>
              </div>
            </div>
            <div class="meta-item">
              <i class="bi bi-envelope"></i>
              <div>
                <span class="meta-label">Email</span>
                <span class="meta-value">{{ user.email }}</span>
              </div>
            </div>
            <div class="meta-item">
              <i class="bi bi-shield-check"></i>
              <div>
                <span class="meta-label">Verification</span>
                <span class="meta-value" [ngClass]="user.emailVerified ? 'verified' : 'not-verified'">
                  {{ user.emailVerified ? 'Verified' : 'Pending' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="profile-actions">
        <div class="action-group">
          <button class="btn-action edit" (click)="editUser()" *ngIf="canEditDelete()">
            <i class="bi bi-pencil"></i>
            <span>Edit Profile</span>
          </button>
          <button class="btn-action status-toggle" 
                  (click)="toggleUserStatus()" 
                  *ngIf="canEditDelete()"
                  [ngClass]="user.status === 'ACTIVE' ? 'deactivate' : 'activate'">
            <i class="bi" [ngClass]="user.status === 'ACTIVE' ? 'bi-person-dash' : 'bi-person-check'"></i>
            <span>{{ user.status === 'ACTIVE' ? 'Deactivate' : 'Activate' }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-section">
      <h2 class="section-title">Performance Overview</h2>
      <div class="stats-grid">
        <div *ngFor="let stat of taskStats" 
             class="stat-card" 
             [ngClass]="stat.gradient"
             (click)="statusFilter = stat.label; setActiveTab('tasks'); applyFilters()">
          <div class="stat-icon-wrapper">
            <i class="bi" [ngClass]="stat.icon"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-count">{{ stat.count }}</h3>
            <p class="stat-label">{{ stat.label.replace('_', ' ') }} Tasks</p>
          </div>
          <div class="stat-trend">
            <i class="bi bi-arrow-right"></i>
          </div>
        </div>
        
        <div class="stat-card total-tasks bg-gradient-to-r from-slate-700 to-slate-900">
          <div class="stat-icon-wrapper">
            <i class="bi bi-clipboard-data"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-count">{{ userTasks.length }}</h3>
            <p class="stat-label">Total Tasks</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-grid">
      <!-- Left Column -->
      <div class="dashboard-left">
        <!-- Tasks Card -->
        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-title">
              <i class="bi bi-list-task"></i>
              <h3>Assigned Tasks</h3>
            </div>
            <div class="card-actions">
              <button class="btn-tab" [class.active]="activeTab === 'tasks'" (click)="setActiveTab('tasks')">
                Tasks
              </button>
              <button class="btn-tab" [class.active]="activeTab === 'departments'" (click)="setActiveTab('departments')">
                Departments
              </button>
              <button class="btn-tab" [class.active]="activeTab === 'logs'" (click)="setActiveTab('logs')">
                Activity
              </button>
            </div>
          </div>
          
          <div class="card-content">
            <!-- Tasks Tab -->
            <div *ngIf="activeTab === 'tasks'" class="tab-content">
              <div class="table-filters">
                <div class="search-box">
                  <i class="bi bi-search"></i>
                  <input type="text" 
                         [(ngModel)]="searchTerm" 
                         (input)="applyFilters()"
                         placeholder="Search tasks...">
                  <button class="btn-clear" (click)="resetFilters()" *ngIf="searchTerm || statusFilter">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
                <div class="filter-options">
                  <select class="filter-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
                    <option value="">All Status</option>
                    <option value="PENDING">Pending</option>
                    <option value="UPCOMING">Upcoming</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="DELAYED">Delayed</option>
                    <option value="CLOSED">Closed</option>
                  </select>
                </div>
              </div>
              
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Task</th>
                      <th>Status</th>
                      <th>Due Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let task of paginatedTasks">
                      <td class="task-cell">
                        <div class="task-info">
                          <div class="task-title">{{ task.title }}</div>
                          <div class="task-id">#{{ task.taskId }}</div>
                        </div>
                      </td>
                      <td>
                        <span class="status-tag" [ngClass]="getTaskStatusClass(task.status)">
                          {{ task.status.replace('_', ' ') }}
                        </span>
                      </td>
                      <td class="due-date">
                        {{ formatDate(task.dueDate) }}
                      </td>
                      <!-- <td>
                        <span class="priority-tag" [ngClass]="'priority-' + (task.priority || 'medium')?.toLowerCase()">
                          {{ task.priority || 'MEDIUM' }}
                        </span>
                      </td> -->
                      <td>
                        <button class="btn-table-action" (click)="viewTask(task.taskId)">
                          <i class="bi bi-eye"></i>
                          View
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                
                <div *ngIf="filteredTasks.length === 0" class="empty-table">
                  <i class="bi bi-clipboard-x"></i>
                  <p>No tasks found</p>
                  <button class="btn-empty-action" (click)="assignNewTask()">
                    Assign First Task
                  </button>
                </div>
              </div>
              
              <div class="table-footer" *ngIf="filteredTasks.length > 0">
               <div class="pagination-info">
  Showing {{ startIndex }}-{{ endIndex }} of {{ filteredTasks.length }} tasks
</div>

                <div class="pagination">
                  <button class="pagination-btn" [disabled]="currentPage === 1" (click)="changePage(1)">
                    <i class="bi bi-chevron-double-left"></i>
                  </button>
                  <button class="pagination-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <div class="page-numbers">
                    <button *ngFor="let page of getPageNumbers()" 
                            class="page-number" 
                            [class.active]="currentPage === page"
                            (click)="changePage(page)">
                      {{ page }}
                    </button>
                  </div>
                  <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                  <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="changePage(totalPages)">
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Departments Tab -->
            <div *ngIf="activeTab === 'departments'" class="tab-content">
              <div class="departments-grid">
                <div *ngFor="let dept of enrichedDepartments" class="department-card">
                  <div class="dept-header" [ngClass]="dept.color">
                    <i class="bi bi-building"></i>
                    <h4>{{ dept.name }}</h4>
                  </div>
                  <div class="dept-content">
                    <div class="dept-info">
                      <div class="info-item">
                        <i class="bi bi-person-badge"></i>
                        <div>
                          <span class="info-label">Head</span>
                          <span class="info-value">{{ dept.hodName }}</span>
                        </div>
                      </div>
                      <div class="info-item">
                        <i class="bi bi-people"></i>
                        <div>
                          <span class="info-label">Members</span>
                          <span class="info-value">{{ dept.userCount }}</span>
                        </div>
                      </div>
                    </div>
                    <button class="btn-view-dept" (click)="viewDepartment(dept.id)">
                      View Department
                      <i class="bi bi-arrow-right"></i>
                    </button>
                  </div>
                </div>
                
                <div *ngIf="enrichedDepartments.length === 0" class="empty-departments">
                  <i class="bi bi-building-x"></i>
                  <p>No departments assigned</p>
                </div>
              </div>
            </div>
            
            <!-- Activity Tab -->
            <div *ngIf="activeTab === 'logs'" class="tab-content">
              <div class="activity-filters">
                <div class="search-box">
                  <i class="bi bi-search"></i>
                  <input type="text" 
                         [(ngModel)]="searchTermLogs" 
                         (input)="applyFiltersLogs()"
                         placeholder="Search activities...">
                  <button class="btn-clear" (click)="resetFiltersLogs()" *ngIf="searchTermLogs">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
              </div>
              
              <div class="activity-list">
                <div *ngFor="let log of paginatedLogs" class="activity-item">
                  <div class="activity-icon" [ngClass]="getActivityColor(log.action)">
                    <i class="bi" [ngClass]="getActivityIcon(log.action)"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-header">
                      <span class="activity-action">{{ log.action }}</span>
                      <span class="activity-entity">{{ log.entity }}</span>
                    </div>
                    <div class="activity-details">
                      {{ log.details || 'No additional details' }}
                    </div>
                    <div class="activity-time">
  {{ formatDate(log.timestamp) }} • {{ formatTime(log.timestamp) }}
</div>

                  </div>
                </div>
                
                <div *ngIf="filteredLogs.length === 0" class="empty-activity">
                  <i class="bi bi-journal-x"></i>
                  <p>No activity logs found</p>
                </div>
              </div>
              
              <div class="table-footer" *ngIf="filteredLogs.length > 0">
                <div class="pagination-info">
  Showing {{ startIndex }}-{{ endIndex }} of {{ filteredTasks.length }} logs
</div>

                <div class="pagination">
                  <button class="pagination-btn" [disabled]="currentPageLogs === 1" (click)="changePageLogs(1)">
                    <i class="bi bi-chevron-double-left"></i>
                  </button>
                  <button class="pagination-btn" [disabled]="currentPageLogs === 1" (click)="changePageLogs(currentPageLogs - 1)">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <div class="page-numbers">
                    <button *ngFor="let page of getPageNumbersLogs()" 
                            class="page-number" 
                            [class.active]="currentPageLogs === page"
                            (click)="changePageLogs(page)">
                      {{ page }}
                    </button>
                  </div>
                  <button class="pagination-btn" [disabled]="currentPageLogs === totalPagesLogs" (click)="changePageLogs(currentPageLogs + 1)">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                  <button class="pagination-btn" [disabled]="currentPageLogs === totalPagesLogs" (click)="changePageLogs(totalPagesLogs)">
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Column -->
      <div class="dashboard-right">
        <!-- Quick Actions Card -->
        <div class="dashboard-card quick-actions-card">
          <div class="card-header">
            <i class="bi bi-lightning-charge"></i>
            <h3>Quick Actions</h3>
          </div>
          <div class="card-content">
            <button class="quick-action-btn primary" (click)="assignNewTask()">
              <i class="bi bi-plus-circle"></i>
              <span>Assign New Task</span>
            </button>
            <button class="quick-action-btn" (click)="editUser()" *ngIf="canEditDelete()">
              <i class="bi bi-pencil-square"></i>
              <span>Edit Profile</span>
            </button>
            <button class="quick-action-btn" (click)="loadUserDetails()">
              <i class="bi bi-arrow-clockwise"></i>
              <span>Refresh Data</span>
            </button>
            <button class="quick-action-btn danger" (click)="deleteUser()" *ngIf="canEditDelete() && user.status === 'ACTIVE'">
              <i class="bi bi-trash"></i>
              <span>Delete User</span>
            </button>
          </div>
        </div>
        
        <!-- Recent Activity Card -->
        <div class="dashboard-card activity-card">
          <div class="card-header">
            <i class="bi bi-clock-history"></i>
            <h3>Recent Activity</h3>
          </div>
          <div class="card-content">
            <div *ngIf="loadingLogs" class="loading-mini">
              <div class="spinner-mini"></div>
              <span>Loading activity...</span>
            </div>
            
            <div *ngIf="!loadingLogs && recentActivity.length > 0" class="recent-activity">
              <div *ngFor="let activity of recentActivity" class="recent-item">
                <div class="recent-icon" [ngClass]="activity.color">
                  <i class="bi" [ngClass]="activity.icon"></i>
                </div>
                <div class="recent-details">
                  <div class="recent-title">{{ activity.action }} • {{ activity.entity }}</div>
                  <div class="recent-time">{{ formatDate(activity.timestamp) }}</div>
                </div>
              </div>
            </div>
            
            <div *ngIf="!loadingLogs && recentActivity.length === 0" class="no-activity">
              <i class="bi bi-journal-x"></i>
              <p>No recent activity</p>
            </div>
            
            <button class="view-all-btn" (click)="setActiveTab('logs')" *ngIf="!loadingLogs && recentActivity.length > 0">
              View All Activity
              <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
        
        <!-- User Info Card -->
        <div class="dashboard-card info-card">
          <div class="card-header">
            <i class="bi bi-info-circle"></i>
            <h3>User Information</h3>
          </div>
          <div class="card-content">
            <div class="info-item">
              <span class="info-label">User ID</span>
              <span class="info-value">{{ user.userId || 'N/A' }}</span>
            </div>
            <!-- <div class="info-item">
              <span class="info-label">Account Created</span>
              <span class="info-value">{{ formatDate(user.createdAt || '') || 'Unknown' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Last Updated</span>
              <span class="info-value">{{ formatDate(user.updatedAt || '') || 'Unknown' }}</span>
            </div> -->
            <div class="info-item">
              <span class="info-label">Total Departments</span>
              <span class="info-value">{{ enrichedDepartments.length }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bottom Action Bar -->
    <div class="action-bar">
      <button class="btn-secondary" (click)="goBack()">
        <i class="bi bi-arrow-left"></i>
        Back to Users
      </button>
      <div class="action-group">
        <button class="btn-action print" onclick="window.print()">
          <i class="bi bi-printer"></i>
          Print
        </button>
      </div>
    </div>
  </div>
</div>